<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 同构 (Isomorphic) | 工欲善其事 必先利其器</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/blog/assets/css/0.styles.5608eb1c.css" as="style"><link rel="preload" href="/blog/assets/js/app.b2f445da.js" as="script"><link rel="preload" href="/blog/assets/js/2.b23598cb.js" as="script"><link rel="preload" href="/blog/assets/js/107.5347b706.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f40c49bb.js"><link rel="prefetch" href="/blog/assets/js/100.689332a2.js"><link rel="prefetch" href="/blog/assets/js/101.53a737e8.js"><link rel="prefetch" href="/blog/assets/js/102.bd15968d.js"><link rel="prefetch" href="/blog/assets/js/103.e3b5ab7a.js"><link rel="prefetch" href="/blog/assets/js/104.04612bc0.js"><link rel="prefetch" href="/blog/assets/js/105.39092398.js"><link rel="prefetch" href="/blog/assets/js/106.056b1e10.js"><link rel="prefetch" href="/blog/assets/js/108.9e1877df.js"><link rel="prefetch" href="/blog/assets/js/109.48a65395.js"><link rel="prefetch" href="/blog/assets/js/11.4ffa0903.js"><link rel="prefetch" href="/blog/assets/js/110.8399578c.js"><link rel="prefetch" href="/blog/assets/js/111.b6cbacb1.js"><link rel="prefetch" href="/blog/assets/js/12.f107d8b4.js"><link rel="prefetch" href="/blog/assets/js/13.fe5dcf2a.js"><link rel="prefetch" href="/blog/assets/js/14.2c1bbb2f.js"><link rel="prefetch" href="/blog/assets/js/15.e342c683.js"><link rel="prefetch" href="/blog/assets/js/16.01611dbd.js"><link rel="prefetch" href="/blog/assets/js/17.4b35d1f4.js"><link rel="prefetch" href="/blog/assets/js/18.d90d26b9.js"><link rel="prefetch" href="/blog/assets/js/19.6929cf14.js"><link rel="prefetch" href="/blog/assets/js/20.f2e09d0e.js"><link rel="prefetch" href="/blog/assets/js/21.11a51a77.js"><link rel="prefetch" href="/blog/assets/js/22.9a931fa0.js"><link rel="prefetch" href="/blog/assets/js/23.73a46047.js"><link rel="prefetch" href="/blog/assets/js/24.dfc8e5df.js"><link rel="prefetch" href="/blog/assets/js/25.4bd151a0.js"><link rel="prefetch" href="/blog/assets/js/26.d9263a49.js"><link rel="prefetch" href="/blog/assets/js/27.6ba6fc97.js"><link rel="prefetch" href="/blog/assets/js/28.3b0d4b92.js"><link rel="prefetch" href="/blog/assets/js/29.3e5d2861.js"><link rel="prefetch" href="/blog/assets/js/3.4e035d78.js"><link rel="prefetch" href="/blog/assets/js/30.9845e6b9.js"><link rel="prefetch" href="/blog/assets/js/31.0ec7d443.js"><link rel="prefetch" href="/blog/assets/js/32.6f146f67.js"><link rel="prefetch" href="/blog/assets/js/33.91251b62.js"><link rel="prefetch" href="/blog/assets/js/34.12315d82.js"><link rel="prefetch" href="/blog/assets/js/35.2fb565eb.js"><link rel="prefetch" href="/blog/assets/js/36.abb66d7e.js"><link rel="prefetch" href="/blog/assets/js/37.a4f4d945.js"><link rel="prefetch" href="/blog/assets/js/38.1cb103d9.js"><link rel="prefetch" href="/blog/assets/js/39.16768a3f.js"><link rel="prefetch" href="/blog/assets/js/4.8de09ba4.js"><link rel="prefetch" href="/blog/assets/js/40.f04612cc.js"><link rel="prefetch" href="/blog/assets/js/41.7eba5ec9.js"><link rel="prefetch" href="/blog/assets/js/42.a0ad03b9.js"><link rel="prefetch" href="/blog/assets/js/43.3a5b8c7d.js"><link rel="prefetch" href="/blog/assets/js/44.149bf643.js"><link rel="prefetch" href="/blog/assets/js/45.75d6e863.js"><link rel="prefetch" href="/blog/assets/js/46.bda586c2.js"><link rel="prefetch" href="/blog/assets/js/47.e3fde493.js"><link rel="prefetch" href="/blog/assets/js/48.b6d1603d.js"><link rel="prefetch" href="/blog/assets/js/49.4a3e2b1a.js"><link rel="prefetch" href="/blog/assets/js/5.493d922f.js"><link rel="prefetch" href="/blog/assets/js/50.8e41f25f.js"><link rel="prefetch" href="/blog/assets/js/51.af69b2b7.js"><link rel="prefetch" href="/blog/assets/js/52.ab543dd4.js"><link rel="prefetch" href="/blog/assets/js/53.03330d16.js"><link rel="prefetch" href="/blog/assets/js/54.f9b8a39c.js"><link rel="prefetch" href="/blog/assets/js/55.7e2cc05d.js"><link rel="prefetch" href="/blog/assets/js/56.10253950.js"><link rel="prefetch" href="/blog/assets/js/57.726c4342.js"><link rel="prefetch" href="/blog/assets/js/58.a4db7ec6.js"><link rel="prefetch" href="/blog/assets/js/59.3f2eab2d.js"><link rel="prefetch" href="/blog/assets/js/6.93147b8d.js"><link rel="prefetch" href="/blog/assets/js/60.33b3fb2b.js"><link rel="prefetch" href="/blog/assets/js/61.a9ccf476.js"><link rel="prefetch" href="/blog/assets/js/62.6ac2723a.js"><link rel="prefetch" href="/blog/assets/js/63.f608e9c4.js"><link rel="prefetch" href="/blog/assets/js/64.3af9c78b.js"><link rel="prefetch" href="/blog/assets/js/65.bed4db2a.js"><link rel="prefetch" href="/blog/assets/js/66.6f6a0547.js"><link rel="prefetch" href="/blog/assets/js/67.32bbb918.js"><link rel="prefetch" href="/blog/assets/js/68.8a2aa5b8.js"><link rel="prefetch" href="/blog/assets/js/69.31e90d71.js"><link rel="prefetch" href="/blog/assets/js/7.6e583e30.js"><link rel="prefetch" href="/blog/assets/js/70.dc8bcdcd.js"><link rel="prefetch" href="/blog/assets/js/71.0c4b4257.js"><link rel="prefetch" href="/blog/assets/js/72.8b8ec59a.js"><link rel="prefetch" href="/blog/assets/js/73.e585f36a.js"><link rel="prefetch" href="/blog/assets/js/74.9ed258b6.js"><link rel="prefetch" href="/blog/assets/js/75.808e0aae.js"><link rel="prefetch" href="/blog/assets/js/76.29463d38.js"><link rel="prefetch" href="/blog/assets/js/77.bbb434fe.js"><link rel="prefetch" href="/blog/assets/js/78.f9492200.js"><link rel="prefetch" href="/blog/assets/js/79.05929e9a.js"><link rel="prefetch" href="/blog/assets/js/8.fa446fbd.js"><link rel="prefetch" href="/blog/assets/js/80.4ee8e988.js"><link rel="prefetch" href="/blog/assets/js/81.dde50274.js"><link rel="prefetch" href="/blog/assets/js/82.a240d58a.js"><link rel="prefetch" href="/blog/assets/js/83.f6cd149e.js"><link rel="prefetch" href="/blog/assets/js/84.68a03f06.js"><link rel="prefetch" href="/blog/assets/js/85.e35e5cee.js"><link rel="prefetch" href="/blog/assets/js/86.79434f11.js"><link rel="prefetch" href="/blog/assets/js/87.53cbadfb.js"><link rel="prefetch" href="/blog/assets/js/88.dfc6b316.js"><link rel="prefetch" href="/blog/assets/js/89.51e23fe1.js"><link rel="prefetch" href="/blog/assets/js/9.17e93b31.js"><link rel="prefetch" href="/blog/assets/js/90.25cb4d99.js"><link rel="prefetch" href="/blog/assets/js/91.1ec0ec7d.js"><link rel="prefetch" href="/blog/assets/js/92.553a02e2.js"><link rel="prefetch" href="/blog/assets/js/93.52653446.js"><link rel="prefetch" href="/blog/assets/js/94.6254718c.js"><link rel="prefetch" href="/blog/assets/js/95.2cdb88b0.js"><link rel="prefetch" href="/blog/assets/js/96.8fdbcce6.js"><link rel="prefetch" href="/blog/assets/js/97.af5b9dda.js"><link rel="prefetch" href="/blog/assets/js/98.ae1bd55d.js"><link rel="prefetch" href="/blog/assets/js/99.26544bf7.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5608eb1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">工欲善其事 必先利其器</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/web-front/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/design-pattern/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/android/" class="nav-link">
  安卓
</a></div><div class="nav-item"><a href="/blog/problems/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/blog/ideas/" class="nav-link">
  想法
</a></div> <a href="https://miguoer.github.io/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/web-front/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/design-pattern/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/android/" class="nav-link">
  安卓
</a></div><div class="nav-item"><a href="/blog/problems/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/blog/ideas/" class="nav-link">
  想法
</a></div> <a href="https://miguoer.github.io/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML核心知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/html-core/html-core.html" class="sidebar-link">LocalStorage扩容</a></li><li><a href="/blog/web-front/html-core/cross-origin.html" class="sidebar-link">跨域问题解决方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript核心知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/js-core/js-core.html" class="sidebar-link">变量提升&amp;函数提升</a></li><li><a href="/blog/web-front/js-core/this.html" class="sidebar-link">this</a></li><li><a href="/blog/web-front/js-core/closure.html" class="sidebar-link">闭包</a></li><li><a href="/blog/web-front/js-core/call&amp;apply.html" class="sidebar-link">call &amp; apply</a></li><li><a href="/blog/web-front/js-core/prototype.html" class="sidebar-link">原型（prototype）</a></li><li><a href="/blog/web-front/js-core/es6-es10.html" class="sidebar-link">ES6-ES10新语法</a></li><li><a href="/blog/web-front/js-core/easy-error.html" class="sidebar-link">易错点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>函数式编程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/function-program/function-program.html" class="sidebar-link">函数式编程介绍</a></li><li><a href="/blog/web-front/function-program/fp-functor.html" class="sidebar-link">范畴 | 容器 | 函子</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Nodejs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/nodejs/nodejs.html" class="sidebar-link">Http 协议</a></li><li><a href="/blog/web-front/nodejs/http-cache.html" class="sidebar-link">Http 的缓存机制</a></li><li><a href="/blog/web-front/nodejs/https.html" class="sidebar-link">Https</a></li><li><a href="/blog/web-front/nodejs/http-next.html" class="sidebar-link">HTTP 各版本分析</a></li><li><a href="/blog/web-front/nodejs/node-part-one.html" class="sidebar-link">Nodejs 初探</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/engineering/engineering.html" class="sidebar-link">工程化入门</a></li><li><a href="/blog/web-front/engineering/build-tools.html" class="sidebar-link">构建工具</a></li><li><a href="/blog/web-front/engineering/node-di.html" class="sidebar-link">Node 端实现 DI 和 IOC</a></li><li><a href="/blog/web-front/engineering/ci-cd.html" class="sidebar-link">CI&amp;CD</a></li><li><a href="/blog/web-front/engineering/quality.html" class="sidebar-link">代码质量管理-SonarQube</a></li><li><a href="/blog/web-front/engineering/test.html" class="sidebar-link">自动化测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/performance/basic-server.html" class="sidebar-link">性能优化服务器基础知识</a></li><li><a href="/blog/web-front/performance/chrome-render-mechanic.html" class="sidebar-link">Chrome浏览器渲染机制</a></li><li><a href="/blog/web-front/performance/performance.html" class="sidebar-link">性能优化学徒工</a></li><li><a href="/blog/web-front/performance/browser-render-process.html" class="sidebar-link">渲染中的性能优化</a></li><li><a href="/blog/web-front/performance/browser-render-param.html" class="sidebar-link">性能指标分析</a></li><li><a href="/blog/web-front/performance/nodejs-promote.html" class="sidebar-link">Nodejs性能调优</a></li><li><a href="/blog/web-front/performance/promote-deep.html" class="sidebar-link">优化原理</a></li><li><a href="/blog/web-front/performance/webpack-promote.html" class="sidebar-link">Webpack4优化</a></li><li><a href="/blog/web-front/performance/react-ssr.html" aria-current="page" class="active sidebar-link">React 同构 (Isomorphic)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#项目使用的主要框架" class="sidebar-link">项目使用的主要框架</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#同构需要解决的问题" class="sidebar-link">同构需要解决的问题</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#webpack改造" class="sidebar-link">webpack改造</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#组件同构" class="sidebar-link">组件同构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#处理静态资源" class="sidebar-link">处理静态资源</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#dom-api" class="sidebar-link">DOM API</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#样式同构" class="sidebar-link">样式同构</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#路由同构" class="sidebar-link">路由同构</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#数据同构" class="sidebar-link">数据同构</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#mpa实现spa效果的原理" class="sidebar-link">MPA实现SPA效果的原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#如何判断切页还是刷页" class="sidebar-link">如何判断切页还是刷页</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#切页如何回吐需要的那部分html" class="sidebar-link">切页如何回吐需要的那部分html</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/performance/react-ssr.html#如何处理事件绑定" class="sidebar-link">如何处理事件绑定</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架源码理解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/framework/framework-react.html" class="sidebar-link">React 源码（一）- createElement</a></li><li><a href="/blog/web-front/framework/framework-react02.html" class="sidebar-link">React 源码（二） - render</a></li><li><a href="/blog/web-front/framework/framework-react03.html" class="sidebar-link">React 源码（三）- hooks</a></li><li><a href="/blog/web-front/framework/framework-react04.html" class="sidebar-link">React 源码分析（四）- 综合</a></li><li><a href="/blog/web-front/framework/framework-react05.html" class="sidebar-link">React 源码分析（五）- Dom Diff</a></li><li><a href="/blog/web-front/framework/framework-redux.html" class="sidebar-link">Redux 源码（一）- Redux 核心</a></li><li><a href="/blog/web-front/framework/framework-redux02.html" class="sidebar-link">Redux 源码（二）- React Redux</a></li><li><a href="/blog/web-front/framework/framework-recoil.html" class="sidebar-link">Recoil 源码</a></li><li><a href="/blog/web-front/framework/framework-webpack01.html" class="sidebar-link">Webpack 核心原理分析（一）打包</a></li><li><a href="/blog/web-front/framework/framework-webpack02.html" class="sidebar-link">Webpack 核心原理分析（二）执行流程</a></li><li><a href="/blog/web-front/framework/framework-webpack03.html" class="sidebar-link">Webpack5 源码分析</a></li><li><a href="/blog/web-front/framework/framework-webpack04.html" class="sidebar-link">现代化的打包工具</a></li><li><a href="/blog/web-front/framework/framework-koa.html" class="sidebar-link">Koa 源码</a></li><li><a href="/blog/web-front/framework/framework-v8-01.html" class="sidebar-link">V8 源码（一）- 基础</a></li><li><a href="/blog/web-front/framework/framework-v8-02.html" class="sidebar-link">V8 源码分析（二）- JS 引擎和渲染引擎</a></li><li><a href="/blog/web-front/framework/framework-v8-03.html" class="sidebar-link">V8 源码分析（三）- 执行过程</a></li><li><a href="/blog/web-front/framework/framework-jsstack.html" class="sidebar-link">javascript 执行堆栈</a></li><li><a href="/blog/web-front/framework/framework-jsobject.html" class="sidebar-link">Javascript 对象和 Map 实现原理</a></li><li><a href="/blog/web-front/framework/framework-invensify.html" class="sidebar-link">Invensify 源码分析</a></li><li><a href="/blog/web-front/framework/framework-jsbridge.html" class="sidebar-link">JSBridge 原理</a></li><li><a href="/blog/web-front/framework/framework-vue2.html" class="sidebar-link">Vue2 源码（一）</a></li><li><a href="/blog/web-front/framework/framework-vue3.html" class="sidebar-link">Vue3源码</a></li><li><a href="/blog/web-front/framework/framework-vuex.html" class="sidebar-link">Vuex源码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>微前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/micro-frontend/micro-frontend.html" class="sidebar-link">微前端概念</a></li><li><a href="/blog/web-front/micro-frontend/micro-frontend-01.html" class="sidebar-link">System.js 方案</a></li><li><a href="/blog/web-front/micro-frontend/micro-frontend-02.html" class="sidebar-link">Webpack5 方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/css/css.html" class="sidebar-link">CSS工作流</a></li><li><a href="/blog/web-front/css/css-houdini.html" class="sidebar-link">CSS Houdini</a></li><li><a href="/blog/web-front/css/css-matrix.html" class="sidebar-link">CSS矩阵</a></li><li><a href="/blog/web-front/css/css-technics.html" class="sidebar-link">CSS技巧总结</a></li><li><a href="/blog/web-front/css/css-lib.html" class="sidebar-link">CSS好用的工具</a></li><li><a href="/blog/web-front/css/css-compatiable.html" class="sidebar-link">CSS兼容性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>手写系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/hand-write/hand-write.html" class="sidebar-link">手写 new</a></li><li><a href="/blog/web-front/hand-write/json.html" class="sidebar-link">json转换</a></li><li><a href="/blog/web-front/hand-write/call.html" class="sidebar-link">call</a></li><li><a href="/blog/web-front/hand-write/bind.html" class="sidebar-link">bind</a></li><li><a href="/blog/web-front/hand-write/extend.html" class="sidebar-link">继承</a></li><li><a href="/blog/web-front/hand-write/curry.html" class="sidebar-link">柯里化</a></li><li><a href="/blog/web-front/hand-write/promise.html" class="sidebar-link">promise</a></li><li><a href="/blog/web-front/hand-write/throttle.html" class="sidebar-link">防抖节流</a></li><li><a href="/blog/web-front/hand-write/clone.html" class="sidebar-link">深拷贝</a></li><li><a href="/blog/web-front/hand-write/instanceof.html" class="sidebar-link">instanceof</a></li><li><a href="/blog/web-front/hand-write/drag.html" class="sidebar-link">拖拽</a></li><li><a href="/blog/web-front/hand-write/settimeout.html" class="sidebar-link">setTimeOut</a></li><li><a href="/blog/web-front/hand-write/object.html" class="sidebar-link">object</a></li><li><a href="/blog/web-front/hand-write/event.html" class="sidebar-link">事件监听</a></li><li><a href="/blog/web-front/hand-write/redux.html" class="sidebar-link">redux</a></li><li><a href="/blog/web-front/hand-write/koa.html" class="sidebar-link">Koa</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目架子</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/project-framework/project-framework.html" class="sidebar-link">项目</a></li><li><a href="/blog/web-front/project-framework/monitor.html" class="sidebar-link">如何做一个监控 SDK</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-同构-isomorphic"><a href="#react-同构-isomorphic" class="header-anchor">#</a> React 同构 (Isomorphic)</h1> <p>所谓同构，就是一个 web 应用在浏览器端和 Node 端共用一套代码。同构直出可以加快首屏渲染速度，提供友好的 SEO。</p> <p>既然我们已经有了服务端渲染，为什么还需要同构？这是因为，传统 MPA 应用的服务端渲染每次切页都会重新加载资源，并且 html 标签先回来，再由客户端去请求加载 js 等资源，虽然可见但不一定可操作。</p> <p>接到同构任务时，一开始觉得这东西既然 react 官方已经提供了解决方案，应该不会太难。但是实际重构的过程却是非常难受的。下面是这次重构过程的总结。</p> <h2 id="项目使用的主要框架"><a href="#项目使用的主要框架" class="header-anchor">#</a> 项目使用的主要框架</h2> <ul><li>webpack</li> <li>react</li> <li>react-router</li> <li>redux</li> <li>styled-components</li> <li>@material-ui</li> <li>koa</li> <li>koa-router</li> <li>koa-swig</li></ul> <h2 id="同构需要解决的问题"><a href="#同构需要解决的问题" class="header-anchor">#</a> 同构需要解决的问题</h2> <ul><li>webpack改造</li> <li>组件同构</li> <li>样式同构</li> <li>路由同构</li> <li>数据同构</li></ul> <h2 id="webpack改造"><a href="#webpack改造" class="header-anchor">#</a> webpack改造</h2> <p>webpack改造这部分和项目相关系太大。我们项目是MPA的，主要工作是把多页变成同构应用，最终把组件都打到一个html中去。服务端用的gulp打包，也用了一些ioc框架。用gulp打包会遇到组件依赖问题，用webpack打包ioc会报错，没有找到好的解决办法，于是重构了一下路由，把ioc去掉了。有时间还是需要继续看看这块怎么把ioc保留。最终的方案是，服务端去掉ioc全部用webpack打包，打成一个server.bundle.js。用Node启动这个server.bundle.js。</p> <p>接下来来看下组件同构。</p> <h2 id="组件同构"><a href="#组件同构" class="header-anchor">#</a> 组件同构</h2> <p>组件同构要解决的问题是在服务端将我们编写的 jsx 或者 tsx 组件渲染出来，再塞到模板里吐回给客户端。
这部分 react 官方已经给出解决方案，只需要使用 react-dom/server 提供的 renderToString 方法，就可以将 react 组件渲染成字符串。代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//server端</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../webapp/shared/Routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> XXXApp <span class="token keyword">from</span> <span class="token string">&quot;../webapp/shared/XXXApp&quot;</span><span class="token punctuation">;</span><span class="token comment">//y应用主路由入口</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_PATH</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isomorphicBody <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//client端 入口</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app-root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="处理静态资源"><a href="#处理静态资源" class="header-anchor">#</a> 处理静态资源</h3> <p>一开始项目是用的 gulp 打包服务端代码，如果按 react 官方推荐的这种写法，编译之后运行会报错。因为我们组件中可能会引入了图片资源，如果没有配置 gulp 不认识这些资源。</p> <p>解决办法就是用 webpack 先把<XXXApp></XXXApp>这个组件编译成一个 node 端的 js 组件。这种办法到目前为止是能解决我们的问题，但是在后续的同构步骤中会发现这种办法不能解决所有问题。这部分后面再介绍。</p> <h3 id="dom-api"><a href="#dom-api" class="header-anchor">#</a> DOM API</h3> <p>组件同构过程中还会碰到的一个问题就是组件中如果用了 window、document、fetch 这些 DOM API 时，启动服务端服务会报错。这是因为服务端没有这些 API。</p> <p>解决办法就是判断代码的执行环境，如果是 Node 端就不使用或者加载这些 DOM API。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> $<span class="token constant">APP</span> <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="样式同构"><a href="#样式同构" class="header-anchor">#</a> 样式同构</h2> <p>样式同构是碰到的比较头疼的问题。我们用的是 styled-components, styled-component 官方给我们提供了一套服务端渲染的机制。
于是，一顿操作：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//server端</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// ... 省略代码</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_PATH</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> styleSheets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    styleSheets<span class="token punctuation">.</span><span class="token function">collectStyles</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> styles <span class="token operator">=</span> styleSheets<span class="token punctuation">.</span><span class="token function">getStyleTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;xxxapp/pages/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拿到html模板</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">,</span> styles<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//动态替换css</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ... 省略代码</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>打包编译重新启动服务之后，样式确实已经出来了。然而，定睛一看，有部分样式仍然很奇怪。进入代码查看这些样式有什么不一样的地方，发现了一个问题，所有出问题的地方都使用了@material-ui 组件。我们知道 material-ui 本身也是基于 styled-components，使用了其中很多的特性。大胆的猜想，styled-components 的服务端渲染方案对 material-ui 并不适用。于是去 material-ui 官网查找服务端渲染方案。(<a href="https://material-ui.com/zh/guides/server-rendering/" target="_blank" rel="noopener noreferrer">@material-ui 服务端渲染方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <p>material-ui 官方提供了一套类似 styled-components 的服务端渲染方案：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheets<span class="token punctuation">,</span> ThemeProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@material-ui/core/styles&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">handleRender</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sheets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将组件渲染成字符串。</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> ReactDOMServer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>
    sheets<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>ThemeProvider theme<span class="token operator">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeProvider<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 从 sheet 中抓取 CSS。</span>
  <span class="token keyword">const</span> css <span class="token operator">=</span> sheets<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将渲染的页面发送回客户端。</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">renderFullPage</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> css<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>既然 styled-components 的服务端渲染方案无法兼容 material-ui，那 material-ui 的方案可以兼容 styled-components 吗？遗憾的是，一顿操作之后，发现还是 Too Young。</p> <p>styled-components 的服务端渲染给我们提供了一个返回 styledComponents 的方法，根据这个继续大胆猜想，那如果先用 styled-components 处理一遍，把返回的组件再交给 material-ui 呢？所幸，这个方法完美运行：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// server</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheets<span class="token punctuation">,</span> ThemeProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@material-ui/core/styles&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_PATH</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;XXXApp/pages/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取到html模板</span>

  <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> styleSheets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  styleSheets<span class="token punctuation">.</span><span class="token function">collectStyles</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isomorphicBody <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    sheet<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>styleSheets<span class="token punctuation">.</span><span class="token function">getStyleElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> styles <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> injectCss <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;style id=&quot;jss-server-side&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/style&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">,</span> injectCss<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInject --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInject --&gt;&quot;</span><span class="token punctuation">,</span> isomorphicBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>如果组件中引入了第三方的css库，可以判断运行环境，Node端不加载，浏览器端再加载。但要用require加载。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//一个轮播组件.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isNode<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/BrowserUtil'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;react-responsive-carousel/lib/styles/carousel.min.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="路由同构"><a href="#路由同构" class="header-anchor">#</a> 路由同构</h2> <p>使用react-router官方提供的同构方案即可。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//server</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_PATH</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;XXXApp/pages/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取到html模板</span>

  <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> styleSheets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  styleSheets<span class="token punctuation">.</span><span class="token function">collectStyles</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">//client</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#panda-app-root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="数据同构"><a href="#数据同构" class="header-anchor">#</a> 数据同构</h2> <p>数据同构是将组件初始化过程中涉及到的网络请求放到服务端去请求，服务端等待所有请求完成之后，将数据注入到组件中，也就是俗称的“注水”操作。</p> <p>数据同构的好处是可以加快首屏渲染速度，减少首屏网络请求。尤其是像我们现在这个项目，首页90%的内容都是需要经过网络请求后再加载的，这个时候做数据同构会极大提升用户体验。</p> <p>数据同构主要用到的技术是redux。实现整套redux的过程步骤多，难度不大。这里主要遇到的问题是数据按项目之前的构建方式，只把XXXAPP这个组件打成一个js的方式行不通了，因此我们引入了路由，路由中定义了组件，直接在node端引入组件就会遇到之前的图片等资源的问题。解决办法就是把server端的入口app.js作为打server.bundle.js的入口，服务端代码全部打到一个js中。</p> <p>最后贴一下最终服务端同构的完整代码，以及客户端入口代码，redux剩下的代码可以按官网操作。</p> <ol><li>服务端</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> historyApiFallback <span class="token keyword">from</span> <span class="token string">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> co <span class="token keyword">from</span> <span class="token string">&quot;co&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> render <span class="token keyword">from</span> <span class="token string">&quot;koa-swig&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> serve <span class="token keyword">from</span> <span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> errorHandler <span class="token keyword">from</span> <span class="token string">&quot;./middlewares/ErrorHandler&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> log4js <span class="token keyword">from</span> <span class="token string">&quot;log4js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Router <span class="token keyword">from</span> <span class="token string">&quot;@koa/router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StaticRouter<span class="token punctuation">,</span> matchPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheets<span class="token punctuation">,</span> ThemeProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@material-ui/core/styles&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> XXXApp <span class="token keyword">from</span> <span class="token string">&quot;../webapp/shared/XXXApp&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createServerStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../webapp/shared/store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">&quot;../webapp/shared/Routes&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token constant">CONTROLLER_PATH</span> <span class="token keyword">from</span> <span class="token string">&quot;./ControllerPath&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Theme <span class="token keyword">from</span> <span class="token string">&quot;../webapp/common/Theme&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ServerStyleSheet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> whiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/lpn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/lpn/api&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    root<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    autoescape<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    cache<span class="token operator">:</span> config<span class="token punctuation">.</span>memoryFlag<span class="token punctuation">,</span>
    ext<span class="token operator">:</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
    varControls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;[[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    writeBody<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//逻辑和业务错误 http日志</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  pm2<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  disableClustering<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  appenders<span class="token operator">:</span> <span class="token punctuation">{</span>
    cheese<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token string">&quot;logs/panda-front.log&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  categories<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      appenders<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      level<span class="token operator">:</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
errorHandler<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CONTROLLER_PATH</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createServerStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  routes<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>loadData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;XXXApp/pages/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sheet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> styleSheets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerStyleSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  styleSheets<span class="token punctuation">.</span><span class="token function">collectStyles</span><span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ThemeProvider theme<span class="token operator">=</span><span class="token punctuation">{</span>Theme<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>StaticRouter location<span class="token operator">=</span><span class="token punctuation">{</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">}</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>StaticRouter<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeProvider<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> isomorphicBody <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>
    sheet<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>styleSheets<span class="token punctuation">.</span><span class="token function">getStyleElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> styles <span class="token operator">=</span> sheet<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> injectCss <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;style id=&quot;jss-server-side&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/style&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectCSS --&gt;&quot;</span><span class="token punctuation">,</span> injectCss<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectReduxStore --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> storeString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script&gt;window.REDUX_STATE = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
      store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInjectReduxStore --&gt;&quot;</span><span class="token punctuation">,</span> storeString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInject --&gt;&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- IsmorphicInject --&gt;&quot;</span><span class="token punctuation">,</span> isomorphicBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务已启动🍺🍞&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><ol start="2"><li>客户端</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * APP主入口
 */</span>
<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ThemeProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;styled-components&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Theme <span class="token keyword">from</span> <span class="token string">&quot;../../common/Theme&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> XXXApp <span class="token keyword">from</span> <span class="token string">&quot;../../shared/XXXApp&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-router-dom&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createClientStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../shared/store&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> jssStyles <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#jss-server-side&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jssStyles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      jssStyles<span class="token punctuation">.</span>parentElement<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>jssStyles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">createClientStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ThemeProvider theme<span class="token operator">=</span><span class="token punctuation">{</span>Theme<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>BrowserRouter<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>XXXApp<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>XXXApp<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>BrowserRouter<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeProvider<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Main <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#panda-app-root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="mpa实现spa效果的原理"><a href="#mpa实现spa效果的原理" class="header-anchor">#</a> MPA实现SPA效果的原理</h2> <p>MPA切页时如果想要达到SPA的效果，需要解决几个问题：</p> <ol><li>node端如何判断是切页还是刷页</li> <li>切页如何回吐需要的那部分html</li> <li>如何处理事件绑定</li></ol> <h3 id="如何判断切页还是刷页"><a href="#如何判断切页还是刷页" class="header-anchor">#</a> 如何判断切页还是刷页</h3> <p>要达到这个目的MPA做页面跳转时只能使用a标签，同时配合 <code>pjax</code> 库。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token operator">%</span> block title <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token operator">%</span> block head <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token operator">%</span> include <span class="token string">&quot;../../components/banner/banner.html&quot;</span><span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token operator">%</span> block content <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.staticfile.org/jquery/3.5.1/jquery.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.staticfile.org/jquery.pjax/2.0.1/jquery.pjax.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
      <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pjax</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token operator">%</span> block scripts <span class="token operator">%</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>子组件：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//html</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;list pjaxcontent&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>展示列表<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>hr <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>h3 id<span class="token operator">=</span><span class="token string">&quot;js-btn&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token comment">//js</span>
<span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'#js-btn'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// $('#js-btn').click(function () {</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'数据加载成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> list<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>node端判断请求头是否有x-pjax</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// import Book from '@models/Book';</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'awilix-koa'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'stream'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cheerio <span class="token keyword">from</span> <span class="token string">'cheerio'</span><span class="token punctuation">;</span>
@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/books'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> booksService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>booksService <span class="token operator">=</span> booksService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>booksService<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'x-pjax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'站内切'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'刷新'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// ctx.body = html;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="切页如何回吐需要的那部分html"><a href="#切页如何回吐需要的那部分html" class="header-anchor">#</a> 切页如何回吐需要的那部分html</h3> <p>使用到的库</p> <ul><li>cheerio</li></ul> <p>node端代码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// import Book from '@models/Book';</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'awilix-koa'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'stream'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> cheerio <span class="token keyword">from</span> <span class="token string">'cheerio'</span><span class="token punctuation">;</span>
@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/books'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">BooksController</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> booksService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>booksService <span class="token operator">=</span> booksService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">actionIndex</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>booksService<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">'x-pjax'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//区分是否</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'站内切'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.pjaxcontent'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//吐需要的html组件</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.lazyload-js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script class=&quot;lazyload-js&quot; src=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token comment">//吐需要的js</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">createSSRStreamPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'落地页'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> htmlStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          htmlStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
          htmlStream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
          ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span><span class="token punctuation">;</span>
          htmlStream
            <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">await</span> <span class="token function">createSSRStreamPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ctx.body = html;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/create'</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">actionCreate</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'books/pages/create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> BooksController<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="如何处理事件绑定"><a href="#如何处理事件绑定" class="header-anchor">#</a> 如何处理事件绑定</h3> <p>如果DOM是js动态添加的，这个时候事件绑定有时会失效。这个时候需要做一层代理，把事件代理到顶层document上。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#js-btn'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'数据加载成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> list<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>解决办法:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'#js-btn'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// $('#js-btn').click(function () {</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'数据加载成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> list<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>react的事件绑定也是绑定到document上。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">10/29/2020, 8:01:15 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/web-front/performance/webpack-promote.html" class="prev">
        Webpack4优化
      </a></span> <span class="next"><a href="/blog/web-front/framework/framework-react.html">
        React 源码（一）- createElement
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b2f445da.js" defer></script><script src="/blog/assets/js/2.b23598cb.js" defer></script><script src="/blog/assets/js/107.5347b706.js" defer></script>
  </body>
</html>
