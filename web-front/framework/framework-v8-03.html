<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>V8 源码分析（三）- 执行过程 | 工欲善其事 必先利其器</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/blog/assets/css/0.styles.5608eb1c.css" as="style"><link rel="preload" href="/blog/assets/js/app.b2f445da.js" as="script"><link rel="preload" href="/blog/assets/js/2.b23598cb.js" as="script"><link rel="preload" href="/blog/assets/js/3.4e035d78.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f40c49bb.js"><link rel="prefetch" href="/blog/assets/js/100.689332a2.js"><link rel="prefetch" href="/blog/assets/js/101.53a737e8.js"><link rel="prefetch" href="/blog/assets/js/102.bd15968d.js"><link rel="prefetch" href="/blog/assets/js/103.e3b5ab7a.js"><link rel="prefetch" href="/blog/assets/js/104.04612bc0.js"><link rel="prefetch" href="/blog/assets/js/105.39092398.js"><link rel="prefetch" href="/blog/assets/js/106.056b1e10.js"><link rel="prefetch" href="/blog/assets/js/107.5347b706.js"><link rel="prefetch" href="/blog/assets/js/108.9e1877df.js"><link rel="prefetch" href="/blog/assets/js/109.48a65395.js"><link rel="prefetch" href="/blog/assets/js/11.4ffa0903.js"><link rel="prefetch" href="/blog/assets/js/110.8399578c.js"><link rel="prefetch" href="/blog/assets/js/111.b6cbacb1.js"><link rel="prefetch" href="/blog/assets/js/12.f107d8b4.js"><link rel="prefetch" href="/blog/assets/js/13.fe5dcf2a.js"><link rel="prefetch" href="/blog/assets/js/14.2c1bbb2f.js"><link rel="prefetch" href="/blog/assets/js/15.e342c683.js"><link rel="prefetch" href="/blog/assets/js/16.01611dbd.js"><link rel="prefetch" href="/blog/assets/js/17.4b35d1f4.js"><link rel="prefetch" href="/blog/assets/js/18.d90d26b9.js"><link rel="prefetch" href="/blog/assets/js/19.6929cf14.js"><link rel="prefetch" href="/blog/assets/js/20.f2e09d0e.js"><link rel="prefetch" href="/blog/assets/js/21.11a51a77.js"><link rel="prefetch" href="/blog/assets/js/22.9a931fa0.js"><link rel="prefetch" href="/blog/assets/js/23.73a46047.js"><link rel="prefetch" href="/blog/assets/js/24.dfc8e5df.js"><link rel="prefetch" href="/blog/assets/js/25.4bd151a0.js"><link rel="prefetch" href="/blog/assets/js/26.d9263a49.js"><link rel="prefetch" href="/blog/assets/js/27.6ba6fc97.js"><link rel="prefetch" href="/blog/assets/js/28.3b0d4b92.js"><link rel="prefetch" href="/blog/assets/js/29.3e5d2861.js"><link rel="prefetch" href="/blog/assets/js/30.9845e6b9.js"><link rel="prefetch" href="/blog/assets/js/31.0ec7d443.js"><link rel="prefetch" href="/blog/assets/js/32.6f146f67.js"><link rel="prefetch" href="/blog/assets/js/33.91251b62.js"><link rel="prefetch" href="/blog/assets/js/34.12315d82.js"><link rel="prefetch" href="/blog/assets/js/35.2fb565eb.js"><link rel="prefetch" href="/blog/assets/js/36.abb66d7e.js"><link rel="prefetch" href="/blog/assets/js/37.a4f4d945.js"><link rel="prefetch" href="/blog/assets/js/38.1cb103d9.js"><link rel="prefetch" href="/blog/assets/js/39.16768a3f.js"><link rel="prefetch" href="/blog/assets/js/4.8de09ba4.js"><link rel="prefetch" href="/blog/assets/js/40.f04612cc.js"><link rel="prefetch" href="/blog/assets/js/41.7eba5ec9.js"><link rel="prefetch" href="/blog/assets/js/42.a0ad03b9.js"><link rel="prefetch" href="/blog/assets/js/43.3a5b8c7d.js"><link rel="prefetch" href="/blog/assets/js/44.149bf643.js"><link rel="prefetch" href="/blog/assets/js/45.75d6e863.js"><link rel="prefetch" href="/blog/assets/js/46.bda586c2.js"><link rel="prefetch" href="/blog/assets/js/47.e3fde493.js"><link rel="prefetch" href="/blog/assets/js/48.b6d1603d.js"><link rel="prefetch" href="/blog/assets/js/49.4a3e2b1a.js"><link rel="prefetch" href="/blog/assets/js/5.493d922f.js"><link rel="prefetch" href="/blog/assets/js/50.8e41f25f.js"><link rel="prefetch" href="/blog/assets/js/51.af69b2b7.js"><link rel="prefetch" href="/blog/assets/js/52.ab543dd4.js"><link rel="prefetch" href="/blog/assets/js/53.03330d16.js"><link rel="prefetch" href="/blog/assets/js/54.f9b8a39c.js"><link rel="prefetch" href="/blog/assets/js/55.7e2cc05d.js"><link rel="prefetch" href="/blog/assets/js/56.10253950.js"><link rel="prefetch" href="/blog/assets/js/57.726c4342.js"><link rel="prefetch" href="/blog/assets/js/58.a4db7ec6.js"><link rel="prefetch" href="/blog/assets/js/59.3f2eab2d.js"><link rel="prefetch" href="/blog/assets/js/6.93147b8d.js"><link rel="prefetch" href="/blog/assets/js/60.33b3fb2b.js"><link rel="prefetch" href="/blog/assets/js/61.a9ccf476.js"><link rel="prefetch" href="/blog/assets/js/62.6ac2723a.js"><link rel="prefetch" href="/blog/assets/js/63.f608e9c4.js"><link rel="prefetch" href="/blog/assets/js/64.3af9c78b.js"><link rel="prefetch" href="/blog/assets/js/65.bed4db2a.js"><link rel="prefetch" href="/blog/assets/js/66.6f6a0547.js"><link rel="prefetch" href="/blog/assets/js/67.32bbb918.js"><link rel="prefetch" href="/blog/assets/js/68.8a2aa5b8.js"><link rel="prefetch" href="/blog/assets/js/69.31e90d71.js"><link rel="prefetch" href="/blog/assets/js/7.6e583e30.js"><link rel="prefetch" href="/blog/assets/js/70.dc8bcdcd.js"><link rel="prefetch" href="/blog/assets/js/71.0c4b4257.js"><link rel="prefetch" href="/blog/assets/js/72.8b8ec59a.js"><link rel="prefetch" href="/blog/assets/js/73.e585f36a.js"><link rel="prefetch" href="/blog/assets/js/74.9ed258b6.js"><link rel="prefetch" href="/blog/assets/js/75.808e0aae.js"><link rel="prefetch" href="/blog/assets/js/76.29463d38.js"><link rel="prefetch" href="/blog/assets/js/77.bbb434fe.js"><link rel="prefetch" href="/blog/assets/js/78.f9492200.js"><link rel="prefetch" href="/blog/assets/js/79.05929e9a.js"><link rel="prefetch" href="/blog/assets/js/8.fa446fbd.js"><link rel="prefetch" href="/blog/assets/js/80.4ee8e988.js"><link rel="prefetch" href="/blog/assets/js/81.dde50274.js"><link rel="prefetch" href="/blog/assets/js/82.a240d58a.js"><link rel="prefetch" href="/blog/assets/js/83.f6cd149e.js"><link rel="prefetch" href="/blog/assets/js/84.68a03f06.js"><link rel="prefetch" href="/blog/assets/js/85.e35e5cee.js"><link rel="prefetch" href="/blog/assets/js/86.79434f11.js"><link rel="prefetch" href="/blog/assets/js/87.53cbadfb.js"><link rel="prefetch" href="/blog/assets/js/88.dfc6b316.js"><link rel="prefetch" href="/blog/assets/js/89.51e23fe1.js"><link rel="prefetch" href="/blog/assets/js/9.17e93b31.js"><link rel="prefetch" href="/blog/assets/js/90.25cb4d99.js"><link rel="prefetch" href="/blog/assets/js/91.1ec0ec7d.js"><link rel="prefetch" href="/blog/assets/js/92.553a02e2.js"><link rel="prefetch" href="/blog/assets/js/93.52653446.js"><link rel="prefetch" href="/blog/assets/js/94.6254718c.js"><link rel="prefetch" href="/blog/assets/js/95.2cdb88b0.js"><link rel="prefetch" href="/blog/assets/js/96.8fdbcce6.js"><link rel="prefetch" href="/blog/assets/js/97.af5b9dda.js"><link rel="prefetch" href="/blog/assets/js/98.ae1bd55d.js"><link rel="prefetch" href="/blog/assets/js/99.26544bf7.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.5608eb1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">工欲善其事 必先利其器</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/web-front/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/design-pattern/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/android/" class="nav-link">
  安卓
</a></div><div class="nav-item"><a href="/blog/problems/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/blog/ideas/" class="nav-link">
  想法
</a></div> <a href="https://miguoer.github.io/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/web-front/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/blog/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/blog/design-pattern/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/blog/android/" class="nav-link">
  安卓
</a></div><div class="nav-item"><a href="/blog/problems/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/blog/ideas/" class="nav-link">
  想法
</a></div> <a href="https://miguoer.github.io/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTML核心知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/html-core/html-core.html" class="sidebar-link">LocalStorage扩容</a></li><li><a href="/blog/web-front/html-core/cross-origin.html" class="sidebar-link">跨域问题解决方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript核心知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/js-core/js-core.html" class="sidebar-link">变量提升&amp;函数提升</a></li><li><a href="/blog/web-front/js-core/this.html" class="sidebar-link">this</a></li><li><a href="/blog/web-front/js-core/closure.html" class="sidebar-link">闭包</a></li><li><a href="/blog/web-front/js-core/call&amp;apply.html" class="sidebar-link">call &amp; apply</a></li><li><a href="/blog/web-front/js-core/prototype.html" class="sidebar-link">原型（prototype）</a></li><li><a href="/blog/web-front/js-core/es6-es10.html" class="sidebar-link">ES6-ES10新语法</a></li><li><a href="/blog/web-front/js-core/easy-error.html" class="sidebar-link">易错点</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>函数式编程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/function-program/function-program.html" class="sidebar-link">函数式编程介绍</a></li><li><a href="/blog/web-front/function-program/fp-functor.html" class="sidebar-link">范畴 | 容器 | 函子</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Nodejs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/nodejs/nodejs.html" class="sidebar-link">Http 协议</a></li><li><a href="/blog/web-front/nodejs/http-cache.html" class="sidebar-link">Http 的缓存机制</a></li><li><a href="/blog/web-front/nodejs/https.html" class="sidebar-link">Https</a></li><li><a href="/blog/web-front/nodejs/http-next.html" class="sidebar-link">HTTP 各版本分析</a></li><li><a href="/blog/web-front/nodejs/node-part-one.html" class="sidebar-link">Nodejs 初探</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/engineering/engineering.html" class="sidebar-link">工程化入门</a></li><li><a href="/blog/web-front/engineering/build-tools.html" class="sidebar-link">构建工具</a></li><li><a href="/blog/web-front/engineering/node-di.html" class="sidebar-link">Node 端实现 DI 和 IOC</a></li><li><a href="/blog/web-front/engineering/ci-cd.html" class="sidebar-link">CI&amp;CD</a></li><li><a href="/blog/web-front/engineering/quality.html" class="sidebar-link">代码质量管理-SonarQube</a></li><li><a href="/blog/web-front/engineering/test.html" class="sidebar-link">自动化测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/performance/basic-server.html" class="sidebar-link">性能优化服务器基础知识</a></li><li><a href="/blog/web-front/performance/chrome-render-mechanic.html" class="sidebar-link">Chrome浏览器渲染机制</a></li><li><a href="/blog/web-front/performance/performance.html" class="sidebar-link">性能优化学徒工</a></li><li><a href="/blog/web-front/performance/browser-render-process.html" class="sidebar-link">渲染中的性能优化</a></li><li><a href="/blog/web-front/performance/browser-render-param.html" class="sidebar-link">性能指标分析</a></li><li><a href="/blog/web-front/performance/nodejs-promote.html" class="sidebar-link">Nodejs性能调优</a></li><li><a href="/blog/web-front/performance/promote-deep.html" class="sidebar-link">优化原理</a></li><li><a href="/blog/web-front/performance/webpack-promote.html" class="sidebar-link">Webpack4优化</a></li><li><a href="/blog/web-front/performance/react-ssr.html" class="sidebar-link">React 同构 (Isomorphic)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>框架源码理解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/framework/framework-react.html" class="sidebar-link">React 源码（一）- createElement</a></li><li><a href="/blog/web-front/framework/framework-react02.html" class="sidebar-link">React 源码（二） - render</a></li><li><a href="/blog/web-front/framework/framework-react03.html" class="sidebar-link">React 源码（三）- hooks</a></li><li><a href="/blog/web-front/framework/framework-react04.html" class="sidebar-link">React 源码分析（四）- 综合</a></li><li><a href="/blog/web-front/framework/framework-react05.html" class="sidebar-link">React 源码分析（五）- Dom Diff</a></li><li><a href="/blog/web-front/framework/framework-redux.html" class="sidebar-link">Redux 源码（一）- Redux 核心</a></li><li><a href="/blog/web-front/framework/framework-redux02.html" class="sidebar-link">Redux 源码（二）- React Redux</a></li><li><a href="/blog/web-front/framework/framework-recoil.html" class="sidebar-link">Recoil 源码</a></li><li><a href="/blog/web-front/framework/framework-webpack01.html" class="sidebar-link">Webpack 核心原理分析（一）打包</a></li><li><a href="/blog/web-front/framework/framework-webpack02.html" class="sidebar-link">Webpack 核心原理分析（二）执行流程</a></li><li><a href="/blog/web-front/framework/framework-webpack03.html" class="sidebar-link">Webpack5 源码分析</a></li><li><a href="/blog/web-front/framework/framework-webpack04.html" class="sidebar-link">现代化的打包工具</a></li><li><a href="/blog/web-front/framework/framework-koa.html" class="sidebar-link">Koa 源码</a></li><li><a href="/blog/web-front/framework/framework-v8-01.html" class="sidebar-link">V8 源码（一）- 基础</a></li><li><a href="/blog/web-front/framework/framework-v8-02.html" class="sidebar-link">V8 源码分析（二）- JS 引擎和渲染引擎</a></li><li><a href="/blog/web-front/framework/framework-v8-03.html" aria-current="page" class="active sidebar-link">V8 源码分析（三）- 执行过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#libuv" class="sidebar-link">libuv</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#观察者" class="sidebar-link">观察者</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#libuv-的-7-个执行阶段" class="sidebar-link">Libuv 的 7 个执行阶段</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#dsl-nlp-ast" class="sidebar-link">DSL NLP AST</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#v8-运行原理-浏览器" class="sidebar-link">V8 运行原理（浏览器）</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#v8-重要的概念" class="sidebar-link">V8 重要的概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#v8-历史" class="sidebar-link">V8 历史</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#v8-落叶归根" class="sidebar-link">V8 落叶归根</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#v8-性能调优" class="sidebar-link">V8 性能调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#类型检查、优化去优化" class="sidebar-link">类型检查、优化去优化</a></li><li class="sidebar-sub-header"><a href="/blog/web-front/framework/framework-v8-03.html#隐藏类和内联缓存" class="sidebar-link">隐藏类和内联缓存</a></li></ul></li></ul></li><li><a href="/blog/web-front/framework/framework-jsstack.html" class="sidebar-link">javascript 执行堆栈</a></li><li><a href="/blog/web-front/framework/framework-jsobject.html" class="sidebar-link">Javascript 对象和 Map 实现原理</a></li><li><a href="/blog/web-front/framework/framework-invensify.html" class="sidebar-link">Invensify 源码分析</a></li><li><a href="/blog/web-front/framework/framework-jsbridge.html" class="sidebar-link">JSBridge 原理</a></li><li><a href="/blog/web-front/framework/framework-vue2.html" class="sidebar-link">Vue2 源码（一）</a></li><li><a href="/blog/web-front/framework/framework-vue3.html" class="sidebar-link">Vue3源码</a></li><li><a href="/blog/web-front/framework/framework-vuex.html" class="sidebar-link">Vuex源码</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>微前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/micro-frontend/micro-frontend.html" class="sidebar-link">微前端概念</a></li><li><a href="/blog/web-front/micro-frontend/micro-frontend-01.html" class="sidebar-link">System.js 方案</a></li><li><a href="/blog/web-front/micro-frontend/micro-frontend-02.html" class="sidebar-link">Webpack5 方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/css/css.html" class="sidebar-link">CSS工作流</a></li><li><a href="/blog/web-front/css/css-houdini.html" class="sidebar-link">CSS Houdini</a></li><li><a href="/blog/web-front/css/css-matrix.html" class="sidebar-link">CSS矩阵</a></li><li><a href="/blog/web-front/css/css-technics.html" class="sidebar-link">CSS技巧总结</a></li><li><a href="/blog/web-front/css/css-lib.html" class="sidebar-link">CSS好用的工具</a></li><li><a href="/blog/web-front/css/css-compatiable.html" class="sidebar-link">CSS兼容性</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>手写系列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/hand-write/hand-write.html" class="sidebar-link">手写 new</a></li><li><a href="/blog/web-front/hand-write/json.html" class="sidebar-link">json转换</a></li><li><a href="/blog/web-front/hand-write/call.html" class="sidebar-link">call</a></li><li><a href="/blog/web-front/hand-write/bind.html" class="sidebar-link">bind</a></li><li><a href="/blog/web-front/hand-write/extend.html" class="sidebar-link">继承</a></li><li><a href="/blog/web-front/hand-write/curry.html" class="sidebar-link">柯里化</a></li><li><a href="/blog/web-front/hand-write/promise.html" class="sidebar-link">promise</a></li><li><a href="/blog/web-front/hand-write/throttle.html" class="sidebar-link">防抖节流</a></li><li><a href="/blog/web-front/hand-write/clone.html" class="sidebar-link">深拷贝</a></li><li><a href="/blog/web-front/hand-write/instanceof.html" class="sidebar-link">instanceof</a></li><li><a href="/blog/web-front/hand-write/drag.html" class="sidebar-link">拖拽</a></li><li><a href="/blog/web-front/hand-write/settimeout.html" class="sidebar-link">setTimeOut</a></li><li><a href="/blog/web-front/hand-write/object.html" class="sidebar-link">object</a></li><li><a href="/blog/web-front/hand-write/event.html" class="sidebar-link">事件监听</a></li><li><a href="/blog/web-front/hand-write/redux.html" class="sidebar-link">redux</a></li><li><a href="/blog/web-front/hand-write/koa.html" class="sidebar-link">Koa</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目架子</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-front/project-framework/project-framework.html" class="sidebar-link">项目</a></li><li><a href="/blog/web-front/project-framework/monitor.html" class="sidebar-link">如何做一个监控 SDK</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="v8-源码分析-三-执行过程"><a href="#v8-源码分析-三-执行过程" class="header-anchor">#</a> V8 源码分析（三）- 执行过程</h1> <h2 id="libuv"><a href="#libuv" class="header-anchor">#</a> libuv</h2> <p>libuv 不属于 V8，但是在执行过程中扮演了一个很重要的角色。</p> <p>在 node.js 启动时，创建了⼀个类似 while(true)的循环体，每次执⾏⼀次循环体称为⼀次 tick，类似于饭店的厨师。每个 tick 的过程就是查看是否有事件等待处理，如果有，则取出事件极及其相关的
回调函数并执⾏，然后执⾏下⼀次 tick。它的执⾏逻辑是，先询问事件观察者当前是否有任务需要执⾏？观察者回答“有”，于是取出
A 执⾏，A 是否有回调函数？如果有（如果没有则继续询问当前是否有任务需要执⾏），则取出回调函数并执⾏(注意：回调函数的执⾏基本都是异步的，可能不⽌⼀个回调)，执⾏完回调后通过某种⽅式通知调⽤者，我执⾏完了，并把执⾏结果给你，主函数不需要不断询问回调函数执⾏结果，回调函数会以通知的⽅式告知调⽤者我执⾏完了，⽽这个过程主线程并不需要等待回调函数执⾏完成，它会继续向前执⾏，直到观察者回答没有了，线程结束。</p> <p><img src="/blog/assets/img/v8_04.59c16c89.jpg" alt=""></p> <p>事件循环是⼀个典型的⽣产者、消费者模型。异步 IO、⽹络请求等则是事件的⽣产者，源源不断为 Node 提供不同类型事件，这些事件被传到观察者哪⾥，事件则从观察者哪⾥取出事件并处理。</p> <p>需要注意的是浏览器的 Event Loop 和 Nodejs 中的 Event Loop 是不一样的。</p> <p>浏览器的是同步执行队列和异步调用栈，事件循环主要就是栈的出栈入栈过程。</p> <p>Node 中靠的是观察者。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">// main.c</span>
int <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个default_loop</span>
    loop <span class="token operator">=</span> <span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    uv_tcp_t server<span class="token punctuation">;</span>
    <span class="token function">uv_tcp_init</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>

    struct sockaddr_in bind_addr<span class="token punctuation">;</span>
    <span class="token function">uv_ip4_addr</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> <span class="token number">7000</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bind_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uv_tcp_bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> struct sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bind_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    int r <span class="token operator">=</span> <span class="token function">uv_listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uv_stream_t<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> on_new_connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">&quot;Listen error %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">uv_err_name</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 启动</span>
    <span class="token keyword">return</span> <span class="token function">uv_run</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> <span class="token constant">UV_RUN_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// uv_run</span>


int <span class="token function">uv_run</span><span class="token punctuation">(</span><span class="token parameter">uv_loop_t<span class="token operator">*</span> loop<span class="token punctuation">,</span> uv_run_mode mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  int timeout<span class="token punctuation">;</span>
  int r<span class="token punctuation">;</span>
  int ran_pending<span class="token punctuation">;</span>

  <span class="token comment">// 检查Loop是否还有异步任务</span>
  r <span class="token operator">=</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">)</span>
    <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// while true 不断从事件循环里取</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loop<span class="token operator">-</span><span class="token operator">&gt;</span>stop_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uv__run_timers</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ran_pending <span class="token operator">=</span> <span class="token function">uv__run_pending</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uv__run_idle</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uv__run_prepare</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">UV_RUN_ONCE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ran_pending<span class="token punctuation">)</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token constant">UV_RUN_DEFAULT</span><span class="token punctuation">)</span>
      timeout <span class="token operator">=</span> <span class="token function">uv_backend_timeout</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">uv__io_poll</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Run one final update on the provider_idle_time in case uv__io_poll
     * returned because the timeout expired, but no events were received. This
     * call will be ignored if the provider_entry_time was either never set (if
     * the timeout == 0) or was already updated b/c an event was received.
     */</span>
    <span class="token function">uv__metrics_update_idle_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">uv__run_check</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">uv__run_closing_handles</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">UV_RUN_ONCE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* UV_RUN_ONCE implies forward progress: at least one callback must have
       * been invoked when it returns. uv__io_poll() can return without doing
       * I/O (meaning: no callbacks) when its timeout expires - which means we
       * have pending timers that satisfy the forward progress constraint.
       *
       * UV_RUN_NOWAIT makes no guarantees about progress so it's omitted from
       * the check.
       */</span>
      <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">uv__run_timers</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    r <span class="token operator">=</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">UV_RUN_ONCE</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token constant">UV_RUN_NOWAIT</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* The if statement lets gcc compile it to a conditional store. Avoids
   * dirtying a cache line.
   */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token operator">-</span><span class="token operator">&gt;</span>stop_flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    loop<span class="token operator">-</span><span class="token operator">&gt;</span>stop_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h3 id="观察者"><a href="#观察者" class="header-anchor">#</a> 观察者</h3> <p>libuv 中的观察者分为 idle 观察者，IO 观察者和 Check 观察者。
<img src="/blog/assets/img/v8_05.8714b49d.jpg" alt="">
这几个观察者的优先级为： idle 观察者&gt;Promise.then&gt; IO 观察者&gt; check 观察者。</p> <p>事件循环中的异步队列有两种，macro task(宏任务)和 micro task（微任务）。宏任务可以有多个，微任务队列只有一个。</p> <ul><li>macro task: script(整体代码)、setTimeout、setInteval、setImmediate，I/O, UI rendering</li> <li>micro-task: process.nextTick，Promise（原生）、Object.observe、MutationObserver。</li></ul> <h3 id="libuv-的-7-个执行阶段"><a href="#libuv-的-7-个执行阶段" class="header-anchor">#</a> Libuv 的 7 个执行阶段</h3> <ol><li><p>update_time
为了获取系统时间，以保证之后的 timer 有计时的目标，避免过多的系统调用影响性能</p></li> <li><p>timers
要检查是否有到期的 timer，也就是 setTimeout 和 setInterval 的 timer</p></li> <li><p>I/O callbacks(epoll, kqueue,IOCP)
I/O 异步事件的回调，比如文件读取 I/O，网络 IO，当这些 IO 动作都结束时调用。</p></li> <li><p>idle,prepare。
这个阶段内部做一些动作，如果节点处理为 active 状态，每个时间循环都会被执行。也就是 process.nextTick 中。</p></li> <li><p>I/O poll
调用各平台提供的 IO 多路复用接口，最多等待 timerout 时间，记录 timeout 自己维护状态，在适当的条件下进行了阻塞。</p></li> <li><p>check
执行 setImmediate 操作</p></li> <li><p>close callbacks
关闭 I/O 的动作，比如文件描述符的关闭，连接断开等等。</p></li></ol> <p><img src="/blog/assets/img/v8_06.e265bcb3.jpg" alt=""></p> <p><img src="/blog/assets/img/v8_07.73304eb3.jpg" alt=""></p> <h2 id="dsl-nlp-ast"><a href="#dsl-nlp-ast" class="header-anchor">#</a> DSL NLP AST</h2> <ol><li>领域特定语⾔指的是专注于某个应⽤程序领域的计算机语
⾔。</li></ol> <p>外部 DSL：宿主应⽤的代码采⽤⽂本解析技术对外部 DSL 编写的脚本进⾏解析。如：正则表达式、SQL、配置⽂件、
koa-swig 模板引擎如 mustache 以及 React、Vue ⽀持的 JSX 语法都属于外部 DSL 等</p> <p>内部 DSL：通⽤语⾔的特定语法，⽤内部 DSL 写成的脚本是⼀段合法的程序。⽐如 PHP C# Java、 jQuery 就可以认为是针对 DOM 操作的⼀种内部 DSL。</p> <p>语法噪⾳：(2).weeks().ago() -&gt; (2).weeks.ago ，(Lambda 表达式本质上是⼀种直观易读且延迟执⾏的逻辑表达能⼒，从⽽避免额外的解析⼯作，不过它强依托宿主的语⾔特性⽀持(匿名函数 + 箭头表示)，并且也会引⼊⼀定的语法噪⾳)</p> <ol start="2"><li><p>抽象语法树（abstract syntax tree 或者缩写为 AST），或者语法树（syntax tree），是 DSL 的抽象语法结构的树状表现形式。</p></li> <li><p>NLP 是自然语言处理</p></li></ol> <p><img src="/blog/assets/img/v8_09.ae8b9030.jpg" alt=""></p> <h2 id="v8-运行原理-浏览器"><a href="#v8-运行原理-浏览器" class="header-anchor">#</a> V8 运行原理（浏览器）</h2> <p>V8 引擎由两个主要部分组成</p> <ol><li>memory heap(内存堆)。这是内存分配地址的地方。闭包，原型链，对象都在内存堆中。</li> <li>Call Stack(调用堆栈)。代码执行的地方。</li> <li>堆外内存。主要是 buffer</li></ol> <p>有些浏览器的 API 经常被使用，比如 setTimeout，但是这些 API 并不是引擎提供的。所以我们还有很多引擎之外的 API，我们把这些 API 称为 Web APIs，比如说 DOM、AJAX、setTimeout 等。</p> <p><img src="/blog/assets/img/v8_10.91165ca5.jpg" alt=""></p> <h2 id="v8-重要的概念"><a href="#v8-重要的概念" class="header-anchor">#</a> V8 重要的概念</h2> <ol><li>闭包</li> <li>一等公民</li> <li>惰性解析</li></ol> <ul><li><p>在 C/C++ 中，你不可以在⼀个函数中定义另外⼀个函数，JavaScript 中函数是⼀等公⺠，本质是因为 JavaScript 函数在 V8 中是 JSFunction 的实例，它实际是 V8 中的⼀个 C++ 对象。C++ 对象是 C++ 世界中当之⽆愧的⼀等公⺠，JavaScript 函数当然也是。（你可以在函数中声明⼀个变量，当然你也可以在函数中声明⼀个函数。C 语⾔编译器把 C 语⾔函数编译成机器码，V8 把 JavaScript 函数编译成 C++ 对象）</p></li> <li><p>惰性解析是指解析器在解析的过程中，如果遇到函数声明，那么会跳过函数内部的代码，并不会为
其⽣成 AST 和字节码，⽽仅仅⽣成顶层代码的 AST 和字节码。利⽤惰性解析可以加速 JavaScript 代码的启动速度，如果要将所有的代码⼀次性解析编译完成，那么会⼤⼤增加⽤户的等待时间。（现在已经不用了，中间版本用过）</p></li> <li><p>JavaScript 是⼀⻔天⽣⽀持闭包的语⾔，闭包会引⽤当前函数作⽤域之外的变量，所以当 V8 解析⼀个函数的时候，还需要判断该函数的内部函数是否引⽤了当前函数内部声明的变量，如果引⽤了，需要将该变量存放到堆中，即便当前函数执⾏结束之后，也不会释放该变量（称预解析）。</p></li></ul> <ul><li>V8 第⼀次执⾏⼀段代码时，会编译源 JavaScript 代码，并将编译后的⼆进制代码缓存在内存中，内存缓存（in-memory cache)。然后通过 JavaScript 源⽂件的字符串在内存中查找对应的编译后的⼆进制代码。V8 除了采⽤将代码缓存在内存中策略之外，还会将代码缓存到硬盘上。</li></ul> <h3 id="v8-历史"><a href="#v8-历史" class="header-anchor">#</a> V8 历史</h3> <p>在 V8 5.9 之前 V8 引擎用了两个编译器，没有解释器，全部直接生成机器码。</p> <p>5.9 发布以后，其中的 Ignition 字节码解释器将默认启动，v8 自此回到了字节码的怀抱。这次 V8 引入字节码却是向着相反的方向后退。因为之前所有 js 代码编译成机器码缓存下来，因为这样不仅缓存占用的内存、磁盘空间很大，而且退出 Chrome 再打开时序列化、反序列化缓存所花费的时间也很长，时间、空间成本都接受不了。所以 V8 退而求其次，只编译最外层的 js 代码，也就是下图这个例子里面绿色的部分。那么内部的代码（如下图中的黄色、红色的部分）是什么时候编译的呢？v8 推迟到第一次被调用的时候再编译。这时间上的推导致被解析多次——绿色的代码一次、黄色的代码再解析一次（当 new Person 被调用）、红色的代码再解析一次（当 doWork() 被调用）。因此，如果你的 js 代码的闭包套了 n 层，那么最终他们至少会被 v8 解析 n 次。所以http://crbug.com/593477第二次执行时间会变长（发
现第一次加载时 v8.CompileScript 花费了 165 ms，再次加载加入 V8.ParseLazy 居然依然花费了 376 ms。）</p> <p>V8 为了减轻机器码占用的内存空间，提高代码的启动速度，对 V8 进行了重构。有了字节码，v8 可以朝着简化的架构方向发展，消除 Cranshaft 这个旧的编译器，并让新的 Turbofan 直接从字节码来优化代码，并当需要进行反优化的时候直接反优化到字节码，而不需要再考虑 JS 源代码。Ignition + TurboFan 的组合，就是字节码解释器 + JIT 编译器的黄金组合。</p> <p><img src="/blog/assets/img/v8_11.522b75fc.jpg" alt=""></p> <h2 id="v8-落叶归根"><a href="#v8-落叶归根" class="header-anchor">#</a> V8 落叶归根</h2> <p><img src="/blog/assets/img/v8_12.c4f68f06.jpg" alt=""></p> <ol><li>源代码-&gt;词法分析-&gt;生成 token -&gt; 语法分析-&gt; AST -&gt; AST 优化 -&gt; 字节码 -&gt; 字节码优化 -&gt; 优化完成交给 run bytecode(JIT)（callee stack, ao, vo , go 就在这里生成的）-&gt; 字节码执行完成产生 callee stack -&gt; AO VO GO 和 scope 作用域链 -&gt; 执行 Javascript 代码。在执行 script 代码过程，如果发现有异步任务，会推到异步队列中。</li> <li>marcotask: setTimeout, setInterval, setImmdiate, Message Channel, I/O, UI rendering, network</li> <li>mircotask: process.netxTick, Promise, MutationObserver</li></ol> <p>例子:
<img src="/blog/assets/img/v8_13.e6fe4de5.jpg" alt=""></p> <h2 id="v8-性能调优"><a href="#v8-性能调优" class="header-anchor">#</a> V8 性能调优</h2> <p>V8 为什么这个高效？如下图:</p> <p><img src="/blog/assets/img/v8_08.84bc9a79.jpg" alt=""></p> <h3 id="类型检查、优化去优化"><a href="#类型检查、优化去优化" class="header-anchor">#</a> 类型检查、优化去优化</h3> <p>V8 使用 type feedback 做动态检查，一般而言会在编译阶段提前检查。检查之后，使用该类型作为动态类型，如果检查失败了，就会去优化。去优化之后，可能会中解释器运行中间码。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去优化</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="隐藏类和内联缓存"><a href="#隐藏类和内联缓存" class="header-anchor">#</a> 隐藏类和内联缓存</h3> <p>有三种不同的命名属性类型: 对象内， 快速/慢速词典。</p> <p>对象属性直接存储在对象本身上，并提供最快的访问权限。快属性位于属性存储中，所有元信息都存储在 HiddenClass 的描述符数组中。慢属性存储在独立的属性字典中，不再通过 HiddenClass 共享元信息。</p> <p>慢属性允许高效的删除和添加属性，但访问速度比其它两种类型慢。</p> <p>V8 利用了另一种优化动态类型语言的技术，称为内联缓存。内联缓存依赖于这样一种观察，即对同一方法的重复调用往往发生在同一类型的对
象上。</p> <p>那么隐藏类和内联缓存的概念如何相关呢？无论何时在特定对象上调用方法时，V8 引擎都必须执行对该对象的隐藏类的查找，以确定访问特定属性的偏移量。在同一个隐藏类的两次成功的调用之后，V8 省略了隐藏类的查找，并简单地将该属
性的偏移量添加到对象指针本身。如果你创建两个相同类型和不同隐藏类的对象，V8 将无法使用内联缓存，因为即使这两个对象属于同一类型，它们对应的隐藏类为其属性分配不同的偏移量。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 此时p1和p2其实使用的是同一个类</span>

<span class="token comment">//但是如果给p2增加一个属性。那会新产生一个类</span>
p2<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">33</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">1/23/2021, 4:30:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/web-front/framework/framework-v8-02.html" class="prev">
        V8 源码分析（二）- JS 引擎和渲染引擎
      </a></span> <span class="next"><a href="/blog/web-front/framework/framework-jsstack.html">
        javascript 执行堆栈
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b2f445da.js" defer></script><script src="/blog/assets/js/2.b23598cb.js" defer></script><script src="/blog/assets/js/3.4e035d78.js" defer></script>
  </body>
</html>
