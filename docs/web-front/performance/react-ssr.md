# React Isomorphic

æ‰€è°“åŒæ„ï¼Œå°±æ˜¯ä¸€ä¸ª web åº”ç”¨åœ¨æµè§ˆå™¨ç«¯å’Œ Node ç«¯å…±ç”¨ä¸€å¥—ä»£ç ã€‚åŒæ„ç›´å‡ºå¯ä»¥åŠ å¿«é¦–å±æ¸²æŸ“é€Ÿåº¦ï¼Œæä¾›å‹å¥½çš„ SEOã€‚

æ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦åŒæ„ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œä¼ ç»Ÿ MPA åº”ç”¨çš„æœåŠ¡ç«¯æ¸²æŸ“æ¯æ¬¡åˆ‡é¡µéƒ½ä¼šé‡æ–°åŠ è½½èµ„æºï¼Œå¹¶ä¸” html æ ‡ç­¾å…ˆå›æ¥ï¼Œå†ç”±å®¢æˆ·ç«¯å»è¯·æ±‚åŠ è½½ js ç­‰èµ„æºï¼Œè™½ç„¶å¯è§ä½†ä¸ä¸€å®šå¯æ“ä½œã€‚

æ¥åˆ°åŒæ„ä»»åŠ¡æ—¶ï¼Œä¸€å¼€å§‹è§‰å¾—è¿™ä¸œè¥¿æ—¢ç„¶ react å®˜æ–¹å·²ç»æä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œåº”è¯¥ä¸ä¼šå¤ªéš¾ã€‚ä½†æ˜¯å®é™…é‡æ„çš„è¿‡ç¨‹å´æ˜¯éå¸¸éš¾å—çš„ã€‚ä¸‹é¢æ˜¯è¿™æ¬¡é‡æ„è¿‡ç¨‹çš„æ€»ç»“ã€‚

## é¡¹ç›®ä½¿ç”¨çš„ä¸»è¦æ¡†æ¶

- webpack
- react
- react-router
- redux
- styled-components
- @material-ui
- koa
- koa-router
- koa-swig

## åŒæ„éœ€è¦è§£å†³çš„é—®é¢˜

- webpackæ”¹é€ 
- ç»„ä»¶åŒæ„
- æ ·å¼åŒæ„
- è·¯ç”±åŒæ„
- æ•°æ®åŒæ„

## webpackæ”¹é€ 
webpackæ”¹é€ è¿™éƒ¨åˆ†å’Œé¡¹ç›®ç›¸å…³ç³»å¤ªå¤§ã€‚æˆ‘ä»¬é¡¹ç›®æ˜¯MPAçš„ï¼Œä¸»è¦å·¥ä½œæ˜¯æŠŠå¤šé¡µå˜æˆåŒæ„åº”ç”¨ï¼Œæœ€ç»ˆæŠŠç»„ä»¶éƒ½æ‰“åˆ°ä¸€ä¸ªhtmlä¸­å»ã€‚æœåŠ¡ç«¯ç”¨çš„gulpæ‰“åŒ…ï¼Œä¹Ÿç”¨äº†ä¸€äº›iocæ¡†æ¶ã€‚ç”¨gulpæ‰“åŒ…ä¼šé‡åˆ°ç»„ä»¶ä¾èµ–é—®é¢˜ï¼Œç”¨webpackæ‰“åŒ…iocä¼šæŠ¥é”™ï¼Œæ²¡æœ‰æ‰¾åˆ°å¥½çš„è§£å†³åŠæ³•ï¼Œäºæ˜¯é‡æ„äº†ä¸€ä¸‹è·¯ç”±ï¼ŒæŠŠiocå»æ‰äº†ã€‚æœ‰æ—¶é—´è¿˜æ˜¯éœ€è¦ç»§ç»­çœ‹çœ‹è¿™å—æ€ä¹ˆæŠŠiocä¿ç•™ã€‚æœ€ç»ˆçš„æ–¹æ¡ˆæ˜¯ï¼ŒæœåŠ¡ç«¯å»æ‰iocå…¨éƒ¨ç”¨webpackæ‰“åŒ…ï¼Œæ‰“æˆä¸€ä¸ªserver.bundle.jsã€‚ç”¨Nodeå¯åŠ¨è¿™ä¸ªserver.bundle.jsã€‚

æ¥ä¸‹æ¥æ¥çœ‹ä¸‹ç»„ä»¶åŒæ„ã€‚

## ç»„ä»¶åŒæ„

ç»„ä»¶åŒæ„è¦è§£å†³çš„é—®é¢˜æ˜¯åœ¨æœåŠ¡ç«¯å°†æˆ‘ä»¬ç¼–å†™çš„ jsx æˆ–è€… tsx ç»„ä»¶æ¸²æŸ“å‡ºæ¥ï¼Œå†å¡åˆ°æ¨¡æ¿é‡Œåå›ç»™å®¢æˆ·ç«¯ã€‚
è¿™éƒ¨åˆ† react å®˜æ–¹å·²ç»ç»™å‡ºè§£å†³æ–¹æ¡ˆï¼Œåªéœ€è¦ä½¿ç”¨ react-dom/server æä¾›çš„ renderToString æ–¹æ³•ï¼Œå°±å¯ä»¥å°† react ç»„ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²ã€‚ä»£ç å¦‚ä¸‹ï¼š

```javascript
//serverç«¯
import { renderToString } from "react-dom/server";
import routes from "../webapp/shared/Routes";
import XXXApp from "../webapp/shared/XXXApp";//yåº”ç”¨ä¸»è·¯ç”±å…¥å£
const router = new Router();
router.get(CONTROLLER_PATH, async (ctx, next) => {
    const isomorphicBody = renderToString(
        <StaticRouter location={ctx.req.url}>
            <XXXApp></XXXApp>
        </StaticRouter>)
}

//clientç«¯ å…¥å£
ReactDOM.hydrate(<BrowserRouter>
          <XXXApp></XXXApp>
        </BrowserRouter>, document.querySelector("#app-root"));
```

### å¤„ç†é™æ€èµ„æº

ä¸€å¼€å§‹é¡¹ç›®æ˜¯ç”¨çš„ gulp æ‰“åŒ…æœåŠ¡ç«¯ä»£ç ï¼Œå¦‚æœæŒ‰ react å®˜æ–¹æ¨èçš„è¿™ç§å†™æ³•ï¼Œç¼–è¯‘ä¹‹åè¿è¡Œä¼šæŠ¥é”™ã€‚å› ä¸ºæˆ‘ä»¬ç»„ä»¶ä¸­å¯èƒ½ä¼šå¼•å…¥äº†å›¾ç‰‡èµ„æºï¼Œå¦‚æœæ²¡æœ‰é…ç½® gulp ä¸è®¤è¯†è¿™äº›èµ„æºã€‚

è§£å†³åŠæ³•å°±æ˜¯ç”¨ webpack å…ˆæŠŠ<XXXApp />è¿™ä¸ªç»„ä»¶ç¼–è¯‘æˆä¸€ä¸ª node ç«¯çš„ js ç»„ä»¶ã€‚è¿™ç§åŠæ³•åˆ°ç›®å‰ä¸ºæ­¢æ˜¯èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨åç»­çš„åŒæ„æ­¥éª¤ä¸­ä¼šå‘ç°è¿™ç§åŠæ³•ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚è¿™éƒ¨åˆ†åé¢å†ä»‹ç»ã€‚

### DOM API

ç»„ä»¶åŒæ„è¿‡ç¨‹ä¸­è¿˜ä¼šç¢°åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ç»„ä»¶ä¸­å¦‚æœç”¨äº† windowã€documentã€fetch è¿™äº› DOM API æ—¶ï¼Œå¯åŠ¨æœåŠ¡ç«¯æœåŠ¡ä¼šæŠ¥é”™ã€‚è¿™æ˜¯å› ä¸ºæœåŠ¡ç«¯æ²¡æœ‰è¿™äº› APIã€‚

è§£å†³åŠæ³•å°±æ˜¯åˆ¤æ–­ä»£ç çš„æ‰§è¡Œç¯å¢ƒï¼Œå¦‚æœæ˜¯ Node ç«¯å°±ä¸ä½¿ç”¨æˆ–è€…åŠ è½½è¿™äº› DOM APIã€‚

```javascript
export function isNode() {
  return typeof window === "undefined";
}

if (!isNode()) {
  const { $APP } = window;
}
```

## æ ·å¼åŒæ„

æ ·å¼åŒæ„æ˜¯ç¢°åˆ°çš„æ¯”è¾ƒå¤´ç–¼çš„é—®é¢˜ã€‚æˆ‘ä»¬ç”¨çš„æ˜¯ styled-components, styled-component å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†ä¸€å¥—æœåŠ¡ç«¯æ¸²æŸ“çš„æœºåˆ¶ã€‚
äºæ˜¯ï¼Œä¸€é¡¿æ“ä½œï¼š

```javascript
//serverç«¯
import { ServerStyleSheet } from "styled-components";
// ... çœç•¥ä»£ç 
router.get(CONTROLLER_PATH, async (ctx, next) => {
    const styleSheets = new ServerStyleSheet();
    styleSheets.collectStyles(
        <StaticRouter location={ctx.req.url}>
          <XXXApp></XXXApp>
        </StaticRouter>
  );

  const styles = styleSheets.getStyleTags();

  var html = await ctx.render("xxxapp/pages/index");//æ‹¿åˆ°htmlæ¨¡æ¿

  if (html.indexOf("<!-- IsmorphicInjectCSS -->") != -1) {
    html = html.replace("<!-- IsmorphicInjectCSS -->", styles);//åŠ¨æ€æ›¿æ¢css
  }

  // ... çœç•¥ä»£ç 
    ctx.body = html;
}
```

æ‰“åŒ…ç¼–è¯‘é‡æ–°å¯åŠ¨æœåŠ¡ä¹‹åï¼Œæ ·å¼ç¡®å®å·²ç»å‡ºæ¥äº†ã€‚ç„¶è€Œï¼Œå®šç›ä¸€çœ‹ï¼Œæœ‰éƒ¨åˆ†æ ·å¼ä»ç„¶å¾ˆå¥‡æ€ªã€‚è¿›å…¥ä»£ç æŸ¥çœ‹è¿™äº›æ ·å¼æœ‰ä»€ä¹ˆä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œå‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰å‡ºé—®é¢˜çš„åœ°æ–¹éƒ½ä½¿ç”¨äº†@material-ui ç»„ä»¶ã€‚æˆ‘ä»¬çŸ¥é“ material-ui æœ¬èº«ä¹Ÿæ˜¯åŸºäº styled-componentsï¼Œä½¿ç”¨äº†å…¶ä¸­å¾ˆå¤šçš„ç‰¹æ€§ã€‚å¤§èƒ†çš„çŒœæƒ³ï¼Œstyled-components çš„æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆå¯¹ material-ui å¹¶ä¸é€‚ç”¨ã€‚äºæ˜¯å» material-ui å®˜ç½‘æŸ¥æ‰¾æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆã€‚([@material-ui æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆ](https://material-ui.com/zh/guides/server-rendering/))ã€‚

material-ui å®˜æ–¹æä¾›äº†ä¸€å¥—ç±»ä¼¼ styled-components çš„æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆï¼š

```javascript
import { ServerStyleSheets, ThemeProvider } from "@material-ui/core/styles";
function handleRender(req, res) {
  const sheets = new ServerStyleSheets();

  // å°†ç»„ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²ã€‚
  const html = ReactDOMServer.renderToString(
    sheets.collect(
      <ThemeProvider theme={theme}>
        <App />
      </ThemeProvider>
    )
  );

  // ä» sheet ä¸­æŠ“å– CSSã€‚
  const css = sheets.toString();

  // å°†æ¸²æŸ“çš„é¡µé¢å‘é€å›å®¢æˆ·ç«¯ã€‚
  res.send(renderFullPage(html, css));
}
```

æ—¢ç„¶ styled-components çš„æœåŠ¡ç«¯æ¸²æŸ“æ–¹æ¡ˆæ— æ³•å…¼å®¹ material-uiï¼Œé‚£ material-ui çš„æ–¹æ¡ˆå¯ä»¥å…¼å®¹ styled-components å—ï¼Ÿé—æ†¾çš„æ˜¯ï¼Œä¸€é¡¿æ“ä½œä¹‹åï¼Œå‘ç°è¿˜æ˜¯ Too Youngã€‚

styled-components çš„æœåŠ¡ç«¯æ¸²æŸ“ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªè¿”å› styledComponents çš„æ–¹æ³•ï¼Œæ ¹æ®è¿™ä¸ªç»§ç»­å¤§èƒ†çŒœæƒ³ï¼Œé‚£å¦‚æœå…ˆç”¨ styled-components å¤„ç†ä¸€éï¼ŒæŠŠè¿”å›çš„ç»„ä»¶å†äº¤ç»™ material-ui å‘¢ï¼Ÿæ‰€å¹¸ï¼Œè¿™ä¸ªæ–¹æ³•å®Œç¾è¿è¡Œï¼š

```javascript
// server

import { ServerStyleSheets, ThemeProvider } from "@material-ui/core/styles";
import { ServerStyleSheet } from "styled-components";
const router = new Router();

// ...
router.get(CONTROLLER_PATH, async (ctx, next) => {
      var html = await ctx.render("XXXApp/pages/index");//è·å–åˆ°htmlæ¨¡æ¿

  const sheet = new ServerStyleSheets();
  const styleSheets = new ServerStyleSheet();
  styleSheets.collectStyles(
        <StaticRouter location={ctx.req.url}>
          <XXXApp></XXXApp>
    </StaticRouter>
  );

const isomorphicBody = renderToString(
    sheet.collect(styleSheets.getStyleElement())
  );

  const styles = sheet.toString();
  if (html.indexOf("<!-- IsmorphicInjectCSS -->") != -1) {
    var injectCss = `<style id="jss-server-side">${styles}</style>`;
    html = html.replace("<!-- IsmorphicInjectCSS -->", injectCss);
  }
  if (html.indexOf("<!-- IsmorphicInject -->") != -1) {
    html = html.replace("<!-- IsmorphicInject -->", isomorphicBody);
  }
  ctx.body = html;
}

```

å¦‚æœç»„ä»¶ä¸­å¼•å…¥äº†ç¬¬ä¸‰æ–¹çš„cssåº“ï¼Œå¯ä»¥åˆ¤æ–­è¿è¡Œç¯å¢ƒï¼ŒNodeç«¯ä¸åŠ è½½ï¼Œæµè§ˆå™¨ç«¯å†åŠ è½½ã€‚ä½†è¦ç”¨requireåŠ è½½ã€‚
```javascript
//ä¸€ä¸ªè½®æ’­ç»„ä»¶.js
import {isNode} from '../utils/BrowserUtil';

if(!isNode()) {
  require("react-responsive-carousel/lib/styles/carousel.min.css");
}
```

## è·¯ç”±åŒæ„
ä½¿ç”¨react-routerå®˜æ–¹æä¾›çš„åŒæ„æ–¹æ¡ˆå³å¯ã€‚
```javascript
//server
router.get(CONTROLLER_PATH, async (ctx, next) => {
      var html = await ctx.render("XXXApp/pages/index");//è·å–åˆ°htmlæ¨¡æ¿

  const sheet = new ServerStyleSheets();
  const styleSheets = new ServerStyleSheet();
  styleSheets.collectStyles(
        <StaticRouter location={ctx.req.url}>
          <XXXApp></XXXApp>
    </StaticRouter>
  );
   // ...
}

//client
ReactDOM.hydrate(<BrowserRouter>
          <XXXApp></XXXApp>
        </BrowserRouter>, document.querySelector("#panda-app-root"));
```

## æ•°æ®åŒæ„
æ•°æ®åŒæ„æ˜¯å°†ç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„ç½‘ç»œè¯·æ±‚æ”¾åˆ°æœåŠ¡ç«¯å»è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆä¹‹åï¼Œå°†æ•°æ®æ³¨å…¥åˆ°ç»„ä»¶ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„â€œæ³¨æ°´â€æ“ä½œã€‚

æ•°æ®åŒæ„çš„å¥½å¤„æ˜¯å¯ä»¥åŠ å¿«é¦–å±æ¸²æŸ“é€Ÿåº¦ï¼Œå‡å°‘é¦–å±ç½‘ç»œè¯·æ±‚ã€‚å°¤å…¶æ˜¯åƒæˆ‘ä»¬ç°åœ¨è¿™ä¸ªé¡¹ç›®ï¼Œé¦–é¡µ90%çš„å†…å®¹éƒ½æ˜¯éœ€è¦ç»è¿‡ç½‘ç»œè¯·æ±‚åå†åŠ è½½çš„ï¼Œè¿™ä¸ªæ—¶å€™åšæ•°æ®åŒæ„ä¼šæå¤§æå‡ç”¨æˆ·ä½“éªŒã€‚

æ•°æ®åŒæ„ä¸»è¦ç”¨åˆ°çš„æŠ€æœ¯æ˜¯reduxã€‚å®ç°æ•´å¥—reduxçš„è¿‡ç¨‹æ­¥éª¤å¤šï¼Œéš¾åº¦ä¸å¤§ã€‚è¿™é‡Œä¸»è¦é‡åˆ°çš„é—®é¢˜æ˜¯æ•°æ®æŒ‰é¡¹ç›®ä¹‹å‰çš„æ„å»ºæ–¹å¼ï¼ŒåªæŠŠXXXAPPè¿™ä¸ªç»„ä»¶æ‰“æˆä¸€ä¸ªjsçš„æ–¹å¼è¡Œä¸é€šäº†ï¼Œå› æ­¤æˆ‘ä»¬å¼•å…¥äº†è·¯ç”±ï¼Œè·¯ç”±ä¸­å®šä¹‰äº†ç»„ä»¶ï¼Œç›´æ¥åœ¨nodeç«¯å¼•å…¥ç»„ä»¶å°±ä¼šé‡åˆ°ä¹‹å‰çš„å›¾ç‰‡ç­‰èµ„æºçš„é—®é¢˜ã€‚è§£å†³åŠæ³•å°±æ˜¯æŠŠserverç«¯çš„å…¥å£app.jsä½œä¸ºæ‰“server.bundle.jsçš„å…¥å£ï¼ŒæœåŠ¡ç«¯ä»£ç å…¨éƒ¨æ‰“åˆ°ä¸€ä¸ªjsä¸­ã€‚

æœ€åè´´ä¸€ä¸‹æœ€ç»ˆæœåŠ¡ç«¯åŒæ„çš„å®Œæ•´ä»£ç ï¼Œä»¥åŠå®¢æˆ·ç«¯å…¥å£ä»£ç ï¼Œreduxå‰©ä¸‹çš„ä»£ç å¯ä»¥æŒ‰å®˜ç½‘æ“ä½œã€‚

1. æœåŠ¡ç«¯
```javascript
import Koa from "koa";
import historyApiFallback from "koa2-connect-history-api-fallback";
import co from "co";
import render from "koa-swig";
import serve from "koa-static";
import errorHandler from "./middlewares/ErrorHandler";
import log4js from "log4js";
import config from "./config";
import Router from "@koa/router";
var path = require("path");
import { StaticRouter, matchPath } from "react-router-dom";
import React from "react";
import { renderToString } from "react-dom/server";
import { ServerStyleSheets, ThemeProvider } from "@material-ui/core/styles";
import { Provider } from "react-redux";
import XXXApp from "../webapp/shared/XXXApp";
import { createServerStore } from "../webapp/shared/store";
import routes from "../webapp/shared/Routes";
import CONTROLLER_PATH from "./ControllerPath";
import Theme from "../webapp/common/Theme";
import { ServerStyleSheet } from "styled-components";
const app = new Koa();
const router = new Router();

app.use(serve(config.staticDir));
app.use(historyApiFallback({ whiteList: ["/lpn", "/lpn/api"] }));
app.context.render = co.wrap(
  render({
    root: path.join(__dirname, "views"),
    autoescape: true,
    cache: config.memoryFlag,
    ext: "html",
    varControls: ["[[", "]]"],
    writeBody: false,
  })
);
//é€»è¾‘å’Œä¸šåŠ¡é”™è¯¯ httpæ—¥å¿—
log4js.configure({
  pm2: true,
  disableClustering: true,
  appenders: {
    cheese: {
      type: "file",
      filename: "logs/panda-front.log",
    },
  },
  categories: {
    default: {
      appenders: ["cheese"],
      level: "info",
    },
  },
});
const logger = log4js.getLogger("cheese");
errorHandler.error(app, logger);

router.get(CONTROLLER_PATH, async (ctx, next) => {
  const promises = [];
  const store = createServerStore();
  routes.some((route) => {
    const match = matchPath(ctx.request.path, route);
    if (match && route.loadData) {
      promises.push(route.loadData(store));
    }
  });
  var html = await ctx.render("XXXApp/pages/index");

  await Promise.all(promises);
  const sheet = new ServerStyleSheets();
  const styleSheets = new ServerStyleSheet();
  styleSheets.collectStyles(
    <Provider store={store}>
      <ThemeProvider theme={Theme}>
        <StaticRouter location={ctx.req.url}>
          <XXXApp></XXXApp>
        </StaticRouter>
      </ThemeProvider>
    </Provider>
  );

  const isomorphicBody = renderToString(
    sheet.collect(styleSheets.getStyleElement())
  );

  const styles = sheet.toString();
  if (html.indexOf("<!-- IsmorphicInjectCSS -->") != -1) {
    var injectCss = `<style id="jss-server-side">${styles}</style>`;
    html = html.replace("<!-- IsmorphicInjectCSS -->", injectCss);
  }

  if (html.indexOf("<!-- IsmorphicInjectReduxStore -->") != -1) {
    var storeString = `<script>window.REDUX_STATE = ${JSON.stringify(
      store.getState()
    )}</script>`;
    html = html.replace("<!-- IsmorphicInjectReduxStore -->", storeString);
  }

  if (html.indexOf("<!-- IsmorphicInject -->") != -1) {
    html = html.replace("<!-- IsmorphicInject -->", isomorphicBody);
  }
  ctx.body = html;
});

app.use(router.routes()).use(router.allowedMethods());

app.listen(config.port, () => {
  console.log("æœåŠ¡å·²å¯åŠ¨ğŸºğŸ", config.port);
});

```

2. å®¢æˆ·ç«¯
```javascript
"use strict";
/**
 * APPä¸»å…¥å£
 */
import React, { useEffect } from "react";
import ReactDOM from "react-dom";
import { ThemeProvider } from "styled-components";
import Theme from "../../common/Theme";
import XXXApp from "../../shared/XXXApp";
import { BrowserRouter } from "react-router-dom";
import { Provider } from "react-redux";
import { createClientStore } from "../../shared/store";

function Main() {
  React.useEffect(() => {
    const jssStyles = document.querySelector("#jss-server-side");
    if (jssStyles) {
      jssStyles.parentElement.removeChild(jssStyles);
    }
  }, []);

  return (
    <Provider store={createClientStore()}>
      <ThemeProvider theme={Theme}>
        <BrowserRouter>
          <XXXApp></XXXApp>
        </BrowserRouter>
      </ThemeProvider>
    </Provider>
  );
}
ReactDOM.hydrate(<Main />, document.querySelector("#panda-app-root"));

```
